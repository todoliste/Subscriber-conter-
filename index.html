<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Changer Fonctionnel</title>
<style>
  body { font-family: Arial; padding: 20px; }
  button { padding: 15px; font-size: 18px; margin: 5px; }
  audio { margin-top: 20px; width: 100%; }
</style>
</head>
<body>

<h2>Voice changer â€“ Enregistrer + ArrÃªter</h2>

<button id="startBtn">ðŸŽ¤ DÃ©marrer</button>
<button id="stopBtn" disabled>â›” ArrÃªter</button>

<audio id="player" controls></audio>
<a id="download" href="#" download="voice.wav">TÃ©lÃ©charger</a>

<script src="https://cdn.jsdelivr.net/npm/soundbank-pitch-shift/dist/pitch-shift.min.js"></script>

<script>
let audioContext;
let mediaStream;
let recorder;
let chunks = [];
let pitchNode;

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const player = document.getElementById("player");
const download = document.getElementById("download");

startBtn.onclick = async () => {
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(mediaStream);

    pitchNode = soundbankPitchShift(audioContext);
    pitchNode.transpose = -6; // voix grave

    // Ã©coute live
    source.connect(pitchNode);
    pitchNode.connect(audioContext.destination);

    // enregistrement
    const dest = audioContext.createMediaStreamDestination();
    pitchNode.connect(dest);

    recorder = new MediaRecorder(dest.stream);

    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);

    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: "audio/wav" });
        const url = URL.createObjectURL(blob);
        player.src = url;
        download.href = url;
    };

    recorder.start();

    startBtn.disabled = true;
    stopBtn.disabled = false;
};

stopBtn.onclick = () => {
    try {
        recorder.stop();
    } catch (e) {
        console.log("Erreur stop:", e);
    }

    mediaStream.getTracks().forEach(t => t.stop());
    audioContext.close();

    startBtn.disabled = false;
    stopBtn.disabled = true;
};
</script>
</body>
</html>