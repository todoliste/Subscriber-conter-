<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enregistreur Vocal + Grave</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
  button { margin: 5px; padding: 10px 20px; font-size: 16px; }
  audio { display: block; margin-top: 20px; width: 100%; }
</style>
</head>
<body>
<h2>Enregistreur Vocal (max 10 min) & Modifier la voix</h2>

<button id="startBtn">üé§ D√©marrer l'enregistrement</button>
<button id="stopBtn" disabled>‚èπ Arr√™ter l'enregistrement</button>
<br>
<label for="pitch">Modifier la voix (grave <-> aigu) :</label>
<input type="range" id="pitch" min="0.5" max="2" step="0.01" value="1">
<span id="pitchValue">1</span>

<audio id="player" controls></audio>

<script>
let mediaRecorder;
let audioChunks = [];
let audioContext;
let sourceNode;
let pitchNode;

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const player = document.getElementById('player');
const pitchSlider = document.getElementById('pitch');
const pitchValue = document.getElementById('pitchValue');

startBtn.onclick = async () => {
    if (!navigator.mediaDevices) {
        alert("Votre navigateur ne supporte pas l'enregistrement audio.");
        return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
        audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);

        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await blob.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        if (sourceNode) sourceNode.disconnect();
        if (pitchNode) pitchNode.disconnect();

        sourceNode = audioContext.createBufferSource();
        sourceNode.buffer = audioBuffer;

        pitchNode = audioContext.createGain(); // on utilisera playbackRate pour changer la hauteur
        sourceNode.connect(pitchNode);
        pitchNode.connect(audioContext.destination);

        sourceNode.playbackRate.value = pitchSlider.value;

        player.src = url;
    };

    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;

    // Arr√™t automatique au bout de 10 min
    setTimeout(() => {
        if (mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    }, 10 * 60 * 1000); // 10 minutes
};

stopBtn.onclick = () => {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
};

pitchSlider.oninput = () => {
    pitchValue.textContent = pitchSlider.value;
    if (sourceNode) {
        sourceNode.playbackRate.value = pitchSlider.value;
    }
};
</script>
</body>
</html>